{% extends "base.html" %}
{% block title %}AiPod - Upload{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Translate Your Podcast</h1>
    <p class="text-gray-400 mb-8">Upload an MP3 file and select a target language. AiPod automatically detects the source language(s) and handles cleanup, transcription, translation, voice cloning, and mastering.</p>

    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="space-y-6">
        <!-- Drop Zone -->
        <div id="drop-zone" class="border-2 border-dashed border-gray-700 rounded-xl p-10 text-center cursor-pointer hover:border-blue-500 transition-colors">
            <div id="drop-text">
                <svg class="mx-auto h-12 w-12 text-gray-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-gray-400">Drag & drop your MP3 file here, or <span class="text-blue-400 underline">browse</span></p>
                <p class="text-gray-600 text-sm mt-1">MP3 files only</p>
            </div>
            <div id="file-info" class="hidden">
                <p class="text-green-400 font-medium" id="file-name"></p>
                <p class="text-gray-500 text-sm" id="file-size"></p>
            </div>
            <input type="file" name="file" id="file-input" accept=".mp3,audio/mpeg" class="hidden" required>
        </div>

        <!-- Target Language -->
        <div>
            <label for="target_language" class="block text-sm font-medium text-gray-300 mb-1">Translate to</label>
            <select name="target_language" id="target_language" required
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Select target language...</option>
                {% for lang in languages %}
                <option value="{{ lang.code }}">{{ lang.name }}</option>
                {% endfor %}
            </select>
            <p class="text-gray-600 text-xs mt-1">Source language(s) will be detected automatically from the audio</p>
        </div>

        <!-- Submit -->
        <button type="submit" id="submit-btn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            Start Translation Pipeline
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const dropZone = document.getElementById("drop-zone");
    const fileInput = document.getElementById("file-input");
    const dropText = document.getElementById("drop-text");
    const fileInfo = document.getElementById("file-info");
    const fileName = document.getElementById("file-name");
    const fileSize = document.getElementById("file-size");
    const submitBtn = document.getElementById("submit-btn");
    const targetLang = document.getElementById("target_language");

    let selectedFile = null;

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / 1048576).toFixed(1) + " MB";
    }

    function checkReady() {
        const hasFile = selectedFile !== null;
        const hasTarget = targetLang.value !== "";
        submitBtn.disabled = !(hasFile && hasTarget);
    }

    function showFile(file) {
        if (!file.name.toLowerCase().endsWith(".mp3")) {
            alert("Please select an MP3 file.");
            return;
        }
        selectedFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = formatSize(file.size);
        dropText.classList.add("hidden");
        fileInfo.classList.remove("hidden");
        checkReady();
    }

    // Click drop zone to open file picker
    dropZone.addEventListener("click", function(e) {
        if (e.target === fileInput) return;
        fileInput.click();
    });
    fileInput.addEventListener("click", function(e) { e.stopPropagation(); });

    // File chosen via picker
    fileInput.addEventListener("change", function() {
        if (fileInput.files.length > 0) {
            showFile(fileInput.files[0]);
        }
    });

    // Drag and drop
    dropZone.addEventListener("dragover", function(e) {
        e.preventDefault();
        dropZone.classList.add("drop-active");
    });
    dropZone.addEventListener("dragleave", function() {
        dropZone.classList.remove("drop-active");
    });
    dropZone.addEventListener("drop", function(e) {
        e.preventDefault();
        dropZone.classList.remove("drop-active");
        if (e.dataTransfer.files.length > 0) {
            showFile(e.dataTransfer.files[0]);
            // Also set the file input so the form submits correctly
            var dt = new DataTransfer();
            dt.items.add(e.dataTransfer.files[0]);
            fileInput.files = dt.files;
        }
    });

    // Language selection
    targetLang.addEventListener("change", checkReady);

    // Handle form submit â€” ensure file input is set
    document.getElementById("upload-form").addEventListener("submit", function(e) {
        if (!selectedFile || !targetLang.value) {
            e.preventDefault();
            return;
        }
    });
})();
</script>
{% endblock %}
